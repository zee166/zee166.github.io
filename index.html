<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Flood Analysis Engine | Command Center</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b0f1a;
            --card-bg: rgba(23, 28, 41, 0.7);
            --accent: #00d2ff;
            --safe: #00ff88;
            --warn: #ffab00;
            --danger: #ff0055;
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        * { box-sizing: border-box; transition: all 0.3s ease; }
        body { 
            font-family: 'Prompt', sans-serif; 
            margin: 0; background: var(--bg); color: #fff; 
            display: flex; min-height: 100vh;
            background-image: radial-gradient(circle at 0% 0%, #16203a 0%, #0b0f1a 50%);
        }

        /* Sidebar */
        .sidebar { 
            width: 340px; background: rgba(10, 15, 28, 0.95); backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border); padding: 30px; display: flex; flex-direction: column; gap: 15px;
        }

        /* Language Switcher */
        .lang-switch {
            display: flex; gap: 5px; margin-bottom: 10px; background: rgba(255,255,255,0.05); padding: 5px; border-radius: 12px;
        }
        .lang-btn {
            flex: 1; border: none; background: transparent; color: #6b7280; padding: 8px; cursor: pointer; border-radius: 8px; font-weight: 600;
        }
        .lang-btn.active { background: var(--accent); color: #000; }

        .config-card { background: var(--card-bg); border: 1px solid var(--glass-border); border-radius: 20px; padding: 20px; }
        .config-card label { font-size: 0.7rem; color: #6b7280; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 8px; }
        .config-card input { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #334155; background: #0f172a; color: var(--accent); font-weight: bold; margin-bottom: 8px; }

        /* Main Content */
        .main { flex: 1; padding: 40px; overflow-y: auto; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card-bg); border: 1px solid var(--glass-border); border-radius: 28px; padding: 25px; text-align: center; }
        .stat-value { font-family: 'Orbitron', sans-serif; font-size: 3rem; font-weight: 700; margin: 10px 0; }

        .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-calib { background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%); color: #000; }
        .btn-reset { background: rgba(255,0,85,0.1); color: var(--danger); border: 1px solid var(--danger); }
        .btn-save { background: var(--safe); color: #000; margin-top: 10px; }
        .btn-mute { background: rgba(255,255,255,0.05); color: #fff; width: auto; padding: 10px 20px; border: 1px solid var(--glass-border); }

        .chart-section { background: var(--card-bg); border: 1px solid var(--glass-border); border-radius: 28px; padding: 25px; height: 400px; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; animation: pulse 2s infinite; }

        @media (max-width: 1100px) { body { flex-direction: column; } .sidebar { width: 100%; } .stats-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="lang-switch">
        <button class="lang-btn active" onclick="setLang('th')" id="btn-th">TH</button>
        <button class="lang-btn" onclick="setLang('en')" id="btn-en">EN</button>
    </div>

    <div style="font-family: 'Orbitron'; font-size: 1.2rem; color: var(--accent); font-weight: 700; text-align: center;">Real-time Flood Analysis Engine
</div>
    
    <div class="config-card">
        <label id="lbl-calib-title">Calibration</label>
        <button class="btn btn-calib" onclick="startCalib()" id="btn-calib-txt">âš¡ AUTO CALIBRATE</button>
        <input type="number" id="base_h" placeholder="0.00 CM" style="margin-top: 10px;">
    </div>

    <div class="config-card">
        <label id="lbl-thresholds">Thresholds (CM)</label>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div><label id="lbl-watch">WATCH</label><input type="number" id="th_w" value="30"></div>
            <div><label id="lbl-alert">ALERT</label><input type="number" id="th_a" value="60"></div>
        </div>
        <label id="lbl-danger">DANGER</label>
        <input type="number" id="th_c" value="100">
    </div>

    <div class="config-card">
        <label id="lbl-notify">Cloud Notification</label>
        <input type="text" id="discord" placeholder="Discord Webhook URL">
        <button class="btn btn-save" onclick="saveSettings()" id="btn-save-txt">SAVE CONFIG</button>
    </div>

    <button class="btn btn-reset" onclick="factoryReset()" id="btn-reset-txt">RESET SYSTEM</button>
</div>

<div class="main">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px;">
        <div>
            <h1 style="margin: 0; font-size: 1.5rem;" id="main-title">Monitoring Dashboard</h1>
            <p style="color: #6b7280; margin: 5px 0 0 0;" id="sub-title">Real-time Flood Analysis Engine</p>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <button id="muteBtn" class="btn btn-mute" onclick="toggleMute()">ðŸ”Š AUDIO ON</button>
            <div id="st_tag" style="padding: 8px 15px; border-radius: 30px; font-size: 0.75rem; display: flex; align-items: center; gap: 8px;">
                <div class="dot"></div> <span id="st_text">SYSTEM LIVE</span>
            </div>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div style="font-size: 0.8rem; color: #6b7280;" id="lbl-depth">WATER DEPTH</div>
            <div class="stat-value" id="depth_v" style="color: var(--accent);">0.0</div>
            <div style="font-size: 0.7rem; letter-spacing: 2px;">CENTIMETERS</div>
        </div>
        <div class="stat-card" id="status_card">
            <div style="font-size: 0.8rem; color: #6b7280;" id="lbl-status">SAFETY STATUS</div>
            <div id="ai_t" style="font-size: 1.5rem; font-weight: 700; margin: 20px 0; color: var(--safe);">STANDBY</div>
            <div id="ai_eta" style="font-size: 0.7rem; color: var(--accent);" id="lbl-wait">WAITING FOR DATA...</div>
        </div>
        <div class="stat-card">
            <div style="font-size: 0.8rem; color: #6b7280;" id="lbl-raw">SENSOR RAW</div>
            <div class="stat-value" id="raw_v" style="color: #334155; font-size: 2.5rem;">0.0</div>
            <div id="h_text" style="font-size: 0.7rem;">CALIBRATED: -- CM</div>
        </div>
    </div>

    <div class="chart-section"><canvas id="floodChart"></canvas></div>
</div>

<div id="calibOverlay" style="display:none; position:fixed; inset:0; background:rgba(11,15,26,0.98); z-index:9999; flex-direction:column; justify-content:center; align-items:center;">
    <div style="font-family:'Orbitron'; font-size: 6rem; color: var(--accent);" id="countdown">30</div>
    <h2 id="calib-msg">SCANNING TERRAIN...</h2>
    <div style="width: 200px; height: 2px; background: #334155; margin-top: 20px;"><div id="p_bar" style="width: 0%; height: 100%; background: var(--accent);"></div></div>
</div>

<script>
    let installHeight = 0, isCalib = false, samples = [], lastSeen = 0, isMuted = false, currentLang = 'th';
    const client = mqtt.connect('wss://broker.hivemq.com:8884/mqtt');

    const dict = {
        th: {
            title: "à¹à¸”à¸Šà¸šà¸­à¸£à¹Œà¸”à¹€à¸à¹‰à¸²à¸£à¸°à¸§à¸±à¸‡à¸™à¹‰à¸³", subtitle: "à¸£à¸°à¸šà¸šà¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸£à¸°à¸”à¸±à¸šà¸™à¹‰à¸³à¹€à¸£à¸µà¸¢à¸¥à¹„à¸—à¸¡à¹Œ", calib_t: "à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸£à¸°à¸”à¸±à¸šà¸žà¸·à¹‰à¸™à¸”à¸´à¸™", 
            btn_calib: "âš¡ à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸žà¸·à¹‰à¸™à¸”à¸´à¸™à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´", thresholds: "à¹€à¸à¸“à¸‘à¹Œà¸à¸²à¸£à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™ (à¸‹à¸¡.)", watch: "à¹€à¸à¹‰à¸²à¸£à¸°à¸§à¸±à¸‡", alert: "à¹€à¸•à¸·à¸­à¸™à¸ à¸±à¸¢",
            danger: "à¸§à¸´à¸à¸¤à¸•", notify: "à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¸œà¹ˆà¸²à¸™à¸„à¸¥à¸²à¸§à¸”à¹Œ", btn_save: "à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²", btn_reset: "à¸£à¸µà¹€à¸‹à¹‡à¸•à¸£à¸°à¸šà¸š",
            depth: "à¸„à¸§à¸²à¸¡à¸¥à¸¶à¸à¸™à¹‰à¸³", status: "à¸ªà¸–à¸²à¸™à¸°à¸„à¸§à¸²à¸¡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢", raw: "à¸£à¸°à¸¢à¸°à¹€à¸‹à¸™à¹€à¸‹à¸­à¸£à¹Œà¸”à¸´à¸š", wait: "à¸£à¸­à¸‚à¹‰à¸­à¸¡à¸¹à¸¥...",
            live: "à¸£à¸°à¸šà¸šà¸—à¸³à¸‡à¸²à¸™à¸­à¸¢à¸¹à¹ˆ", offline: "à¸­à¸¸à¸›à¸à¸£à¸“à¹Œà¸­à¸­à¸Ÿà¹„à¸¥à¸™à¹Œ", calib_msg: "à¸à¸³à¸¥à¸±à¸‡à¸ªà¹à¸à¸™à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆ...", 
            safe: "à¸›à¸à¸•à¸´", warn_st: "à¹€à¸à¹‰à¸²à¸£à¸°à¸§à¸±à¸‡", alert_st: "à¹€à¸•à¸·à¸­à¸™à¸ à¸±à¸¢", danger_st: "à¸§à¸´à¸à¸¤à¸•", audio_on: "ðŸ”Š à¹€à¸›à¸´à¸”à¹€à¸ªà¸µà¸¢à¸‡", audio_off: "ðŸ”‡ à¸›à¸´à¸”à¹€à¸ªà¸µà¸¢à¸‡"
        },
        en: {
            title: "Monitoring Dashboard", subtitle: "Real-time Flood Analysis Engine", calib_t: "System Calibration", 
            btn_calib: "âš¡ AUTO CALIBRATE", thresholds: "Alert Thresholds (CM)", watch: "WATCH", alert: "ALERT",
            danger: "DANGER", notify: "Cloud Notification", btn_save: "SAVE CONFIG", btn_reset: "RESET SYSTEM",
            depth: "WATER DEPTH", status: "SAFETY STATUS", raw: "SENSOR RAW", wait: "WAITING FOR DATA...",
            live: "SYSTEM LIVE", offline: "DEVICE OFFLINE", calib_msg: "SCANNING TERRAIN...",
            safe: "SAFE", warn_st: "WATCH", alert_st: "ALERT", danger_st: "CRITICAL", audio_on: "ðŸ”Š AUDIO ON", audio_off: "ðŸ”‡ AUDIO OFF"
        }
    };

    function setLang(lang) {
        currentLang = lang;
        localStorage.setItem('pref_lang', lang);
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + lang).classList.add('active');
        
        const d = dict[lang];
        document.getElementById('main-title').innerText = d.title;
        document.getElementById('sub-title').innerText = d.subtitle;
        document.getElementById('lbl-calib-title').innerText = d.calib_t;
        document.getElementById('btn-calib-txt').innerText = d.btn_calib;
        document.getElementById('lbl-thresholds').innerText = d.thresholds;
        document.getElementById('lbl-watch').innerText = d.watch;
        document.getElementById('lbl-alert').innerText = d.alert;
        document.getElementById('lbl-danger').innerText = d.danger;
        document.getElementById('lbl-notify').innerText = d.notify;
        document.getElementById('btn-save-txt').innerText = d.btn_save;
        document.getElementById('btn-reset-txt').innerText = d.btn_reset;
        document.getElementById('lbl-depth').innerText = d.depth;
        document.getElementById('lbl-status').innerText = d.status;
        document.getElementById('lbl-raw').innerText = d.raw;
        document.getElementById('calib-msg').innerText = d.calib_msg;
        updateStatusText(); // Update live status text
    }

    // Logic Functions (Same as before but with lang support)
    client.on('connect', () => client.subscribe('flood/sensor/level'));
    client.on('message', (t, m) => {
        const raw = parseFloat(m.toString());
        lastSeen = Date.now();
        document.getElementById('raw_v').innerText = raw.toFixed(1);
        if (isCalib) {
            samples.push(raw);
            document.getElementById('p_bar').style.width = (samples.length/30)*100 + '%';
            document.getElementById('countdown').innerText = 30 - samples.length;
            if (samples.length >= 30) finalizeCalib();
        } else if (installHeight > 0) updateDashboard(Math.max(0, installHeight - raw));
    });

    function startCalib() { document.getElementById('calibOverlay').style.display = 'flex'; isCalib = true; samples = []; }
    function finalizeCalib() {
        isCalib = false; document.getElementById('calibOverlay').style.display = 'none';
        samples.sort((a,b) => a-b);
        document.getElementById('base_h').value = samples[Math.floor(samples.length/2)].toFixed(1);
        saveSettings();
    }

    function saveSettings() {
        const cfg = { h: document.getElementById('base_h').value, w: document.getElementById('th_w').value, a: document.getElementById('th_a').value, c: document.getElementById('th_c').value, u: document.getElementById('discord').value };
        localStorage.setItem('flood_cfg_intl', JSON.stringify(cfg));
        installHeight = parseFloat(cfg.h);
        document.getElementById('h_text').innerText = `CALIBRATED: ${installHeight} CM`;
        Swal.fire({ icon: 'success', title: currentLang === 'th' ? 'à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸³à¹€à¸£à¹‡à¸ˆ' : 'SAVED', background: '#161c2e', color: '#fff', timer: 1000, showConfirmButton: false });
    }

    function updateDashboard(d) {
        document.getElementById('depth_v').innerText = d.toFixed(1);
        const c = JSON.parse(localStorage.getItem('flood_cfg_intl') || '{}');
        const trend = document.getElementById('ai_t');
        const d_en = dict['en'], d_th = dict['th'];

        if(d >= c.c) { trend.innerText = dict[currentLang].danger_st; trend.style.color = "var(--danger)"; }
        else if(d >= c.a) { trend.innerText = dict[currentLang].alert_st; trend.style.color = "var(--warn)"; }
        else { trend.innerText = dict[currentLang].safe; trend.style.color = "var(--safe)"; }
        
        // Update Chart... (same as before)
    }

    function updateStatusText() {
        const isOnline = Date.now() - lastSeen < 8000;
        const txt = document.getElementById('st_text');
        const st = document.getElementById('st_tag');
        txt.innerText = isOnline ? dict[currentLang].live : dict[currentLang].offline;
        st.style.color = isOnline ? "var(--safe)" : "var(--danger)";
        st.style.background = isOnline ? "rgba(0,255,136,0.1)" : "rgba(255,0,85,0.1)";
    }

    function toggleMute() {
        isMuted = !isMuted;
        document.getElementById('muteBtn').innerText = isMuted ? dict[currentLang].audio_off : dict[currentLang].audio_on;
    }

    function factoryReset() {
        Swal.fire({ title: currentLang === 'th' ? 'à¸¥à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥?' : 'ERASE?', icon: 'warning', showCancelButton: true, background: '#161c2e', color: '#fff' }).then(r => { if(r.isConfirmed) { localStorage.clear(); location.reload(); }});
    }

    setInterval(updateStatusText, 4000);
    window.onload = () => {
        const savedLang = localStorage.getItem('pref_lang') || 'th';
        setLang(savedLang);
        const savedCfg = localStorage.getItem('flood_cfg_intl');
        if(savedCfg) {
            const c = JSON.parse(savedCfg);
            document.getElementById('base_h').value = c.h; document.getElementById('th_w').value = c.w;
            document.getElementById('th_a').value = c.a; document.getElementById('th_c').value = c.c;
            document.getElementById('discord').value = c.u;
            installHeight = parseFloat(c.h);
        }
    };
</script>
</body>
</html>
