<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HydroGuard | Premium Analysis Dashboard</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b0f1a;
            --card-bg: rgba(23, 28, 41, 0.7);
            --accent: #00d2ff;
            --safe: #00ff88;
            --warn: #ffab00;
            --danger: #ff0055;
            --glass-border: rgba(255, 255, 255, 0.08);
        }
        * { box-sizing: border-box; transition: all 0.3s ease; }
        body { font-family: 'Prompt', sans-serif; margin: 0; background: var(--bg); color: #fff; display: flex; min-height: 100vh; background-image: radial-gradient(circle at 0% 0%, #16203a 0%, #0b0f1a 50%); }
        .sidebar { width: 340px; background: rgba(10, 15, 28, 0.95); backdrop-filter: blur(20px); border-right: 1px solid var(--glass-border); padding: 30px; display: flex; flex-direction: column; gap: 15px; }
        .lang-switch { display: flex; gap: 5px; margin-bottom: 10px; background: rgba(255,255,255,0.05); padding: 5px; border-radius: 12px; }
        .lang-btn { flex: 1; border: none; background: transparent; color: #6b7280; padding: 8px; cursor: pointer; border-radius: 8px; font-weight: 600; }
        .lang-btn.active { background: var(--accent); color: #000; }
        .config-card { background: var(--card-bg); border: 1px solid var(--glass-border); border-radius: 20px; padding: 20px; }
        .config-card label { font-size: 0.7rem; color: #6b7280; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 8px; }
        .config-card input { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #334155; background: #0f172a; color: var(--accent); font-weight: bold; margin-bottom: 8px; }
        .main { flex: 1; padding: 40px; overflow-y: auto; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card-bg); border: 1px solid var(--glass-border); border-radius: 28px; padding: 25px; text-align: center; }
        .stat-value { font-family: 'Orbitron', sans-serif; font-size: 3rem; font-weight: 700; margin: 10px 0; }
        .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-calib { background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%); color: #000; }
        .btn-reset { background: rgba(255,0,85,0.1); color: var(--danger); border: 1px solid var(--danger); }
        .btn-save { background: var(--safe); color: #000; margin-top: 10px; }
        .btn-mute { background: rgba(255,255,255,0.05); color: #fff; width: auto; padding: 10px 20px; border: 1px solid var(--glass-border); }
        .btn-mute.muted { background: var(--danger); color: #fff; border-color: transparent; }
        .chart-section { background: var(--card-bg); border: 1px solid var(--glass-border); border-radius: 28px; padding: 25px; height: 350px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        #calibOverlay { display:none; position:fixed; inset:0; background:rgba(11,15,26,0.98); z-index:9999; flex-direction:column; justify-content:center; align-items:center; }
        .sync-tag { font-size: 0.6rem; color: var(--safe); margin-top: -5px; margin-bottom: 5px; display: block; opacity: 0.8; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="lang-switch">
        <button class="lang-btn active" onclick="setLang('th')" id="btn-th">TH</button>
        <button class="lang-btn" onclick="setLang('en')" id="btn-en">EN</button>
    </div>
    <div style="font-family: 'Orbitron'; font-size: 1.2rem; color: var(--accent); font-weight: 700; text-align: center;" id="lbl-settings">Settings</div>
    <div class="config-card">
        <label id="lbl-calib-title">Ground Setup</label>
        <button class="btn btn-calib" onclick="startCalib()" id="btn-calib-txt">‚ö° AUTO CALIBRATE</button>
        <input type="number" id="base_h" placeholder="0.00 CM" style="margin-top: 10px;" readonly>
        <span class="sync-tag" id="sync-base">‚óè Waiting...</span>
    </div>
    <div class="config-card">
        <label id="lbl-thresholds">Danger Zones</label>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div><label id="lbl-watch">WATCH</label><input type="number" id="th_w" value="30"></div>
            <div><label id="lbl-alert">ALERT</label><input type="number" id="th_a" value="60"></div>
        </div>
        <label id="lbl-danger">CRITICAL</label>
        <input type="number" id="th_c" value="100">
    </div>
    <div class="config-card">
        <label id="lbl-notify">Discord Alert</label>
        <input type="text" id="discord" placeholder="Webhook URL">
        <button class="btn btn-save" onclick="saveSettings()" id="btn-save-txt">SAVE SETTINGS</button>
    </div>
    <button class="btn btn-reset" onclick="factoryReset()" id="btn-reset-txt">FACTORY RESET</button>
</div>

<div class="main">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px;">
        <div>
            <h1 style="margin: 0; font-size: 1.5rem;" id="main-title">Monitoring Dashboard</h1>
            <p style="color: #6b7280; margin: 5px 0 0 0;" id="sub-title">Real-time Flood Analysis Engine</p>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <button id="muteBtn" class="btn btn-mute" onclick="toggleMute()">üîä AUDIO ON</button>
            <div id="st_tag" style="padding: 8px 15px; border-radius: 30px; font-size: 0.75rem; display: flex; align-items: center; gap: 8px;">
                <div class="dot"></div> <span id="st_text">CONNECTING...</span>
            </div>
        </div>
    </div>
    <div class="stats-grid">
        <div class="stat-card">
            <div style="font-size: 0.8rem; color: #6b7280;" id="lbl-depth">WATER DEPTH</div>
            <div class="stat-value" id="depth_v" style="color: var(--accent);">0.0</div>
            <div style="font-size: 0.7rem; letter-spacing: 2px;" id="lbl-unit-cm">CENTIMETERS</div>
        </div>
        <div class="stat-card">
            <div style="font-size: 0.8rem; color: #6b7280;" id="lbl-status">SAFETY STATUS</div>
            <div id="ai_t" style="font-size: 1.5rem; font-weight: 700; margin: 20px 0; color: var(--safe);">IDLE</div>
            <div id="ai_wait" style="font-size: 0.7rem; color: var(--accent);">WAITING FOR DATA...</div>
        </div>
        <div class="stat-card">
            <div style="font-size: 0.8rem; color: #6b7280;" id="lbl-raw">SENSOR RAW</div>
            <div class="stat-value" id="raw_v" style="color: #334155; font-size: 2.5rem;">0.0</div>
            <div id="h_text" style="font-size: 0.7rem;">CALIBRATED</div>
        </div>
    </div>
    <div class="chart-section"><canvas id="floodChart"></canvas></div>
</div>

<div id="calibOverlay">
    <div style="font-family:'Orbitron'; font-size: 6rem; color: var(--accent);" id="countdown">30</div>
    <h2 id="calib-msg">SCANNING TERRAIN...</h2>
    <div style="width: 200px; height: 2px; background: #334155; margin-top: 20px;"><div id="p_bar" style="width: 0%; height: 100%; background: var(--accent);"></div></div>
</div>

<script>
    const mqtt_url = 'wss://e10d38d9fdee4dd7809fd84de819c22a.s1.eu.hivemq.cloud:8884/mqtt';
    const mqtt_options = { username: 'Zee071250', password: '071250Za', clientId: 'Web_Dash_' + Math.random().toString(16).substr(2, 5) };

    let installHeight = 0, isCalib = false, samples = [], lastSeen = 0, isMuted = false, currentLang = 'th';
    let floodChart, lastSentLevel = "", lastNotifyTime = 0;
    const NOTIFY_COOLDOWN = 3000;

    const dict = {
        th: {
            title: "‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ô‡πâ‡∏≥", subtitle: "‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå", settings: "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö",
            calib_t: "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏î‡∏¥‡∏ô", btn_calib: "‚ö° ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏î‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥", thresholds: "‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡∏ã‡∏°.)",
            watch: "‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á", alert: "‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏†‡∏±‡∏¢", danger: "‡∏ß‡∏¥‡∏Å‡∏§‡∏ï", notify: "‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå",
            btn_save: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤", btn_reset: "‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö", depth: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∂‡∏Å‡∏ô‡πâ‡∏≥", unit_cm: "‡πÄ‡∏ã‡∏ô‡∏ï‡∏¥‡πÄ‡∏°‡∏ï‡∏£",
            status: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢", raw: "‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ã‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏î‡∏¥‡∏ö", wait: "‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...", live: "‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà",
            offline: "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå", calib_msg: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà...", audio_on: "üîä ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á",
            audio_off: "üîá ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á", safe: "‡∏õ‡∏Å‡∏ï‡∏¥", warn_st: "‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á", alert_st: "‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏†‡∏±‡∏¢",
            danger_st: "‡∏ß‡∏¥‡∏Å‡∏§‡∏ï‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢", sync_ok: "‚óè ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß", sync_wait: "‚óè ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠...",
            dis_title: "üåä HydroGuard Monitoring System", dis_sub: "‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á: ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥",
            dis_link: "‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Dashboard ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå", dis_status: "üìã ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö", dis_lvl: "‡∏£‡∏∞‡∏î‡∏±‡∏ö",
            dis_pri: "‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç", dis_now: "üìè ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î", dis_inst: "üèóÔ∏è ‡∏£‡∏∞‡∏¢‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á",
            dis_anal: "üìä ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå", dis_footer: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏±‡∏î Node-01 ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™ Secure MQTT",
            pri_low: "LOW", pri_med: "MEDIUM", pri_high: "HIGH"
        },
        en: {
            title: "Flood Dashboard", subtitle: "Real-time Analysis Engine", settings: "Control Panel",
            calib_t: "Ground Setup", btn_calib: "‚ö° AUTO CALIBRATE", thresholds: "Alert Thresholds (CM)",
            watch: "WATCH", alert: "ALERT", danger: "CRITICAL", notify: "Cloud Notification",
            btn_save: "SAVE SETTINGS", btn_reset: "RESET SYSTEM", depth: "WATER DEPTH", unit_cm: "CENTIMETERS",
            status: "SAFETY STATUS", raw: "SENSOR RAW", wait: "WAITING FOR DATA...", live: "SYSTEM LIVE",
            offline: "OFFLINE", calib_msg: "SCANNING SURFACE...", audio_on: "üîä AUDIO ON",
            audio_off: "üîá AUDIO OFF", safe: "SAFE", warn_st: "WATCHING", alert_st: "ALERT",
            danger_st: "CRITICAL", sync_ok: "‚óè SYNCED", sync_wait: "‚óè WAITING...",
            dis_title: "üåä HydroGuard Monitoring System", dis_sub: "Flood Warning: Unusual Water Level",
            dis_link: "Open Real-time Dashboard", dis_status: "üìã System Status", dis_lvl: "Level",
            dis_pri: "Priority", dis_now: "üìè Current Level", dis_inst: "üèóÔ∏è Install Height",
            dis_anal: "üìä Analysis", dis_footer: "Data from Station Node-01 via Secure MQTT",
            pri_low: "LOW", pri_med: "MEDIUM", pri_high: "HIGH"
        }
    };

    const client = mqtt.connect(mqtt_url, mqtt_options);

    client.on('connect', () => { 
        client.subscribe('flood/sensor/level'); 
        client.subscribe('flood/sensor/base_confirm');
        updateStatusText(); 
    });

    client.on('message', (topic, message) => {
        const val = message.toString();
        lastSeen = Date.now();
        if (topic === 'flood/sensor/level') {
            const num = parseFloat(val);
            document.getElementById('raw_v').innerText = num.toFixed(1);
            if (isCalib) {
                samples.push(num);
                document.getElementById('p_bar').style.width = (samples.length/30)*100 + '%';
                document.getElementById('countdown').innerText = 30 - samples.length;
                if (samples.length >= 30) finalizeCalib();
            } else if (installHeight > 0) {
                updateDashboard(Math.max(0, installHeight - num));
            }
        }
        if (topic === 'flood/sensor/base_confirm') {
            installHeight = parseFloat(val);
            document.getElementById('base_h').value = installHeight.toFixed(1);
            document.getElementById('sync-base').innerText = dict[currentLang].sync_ok;
        }
    });

    function updateDashboard(d) {
        document.getElementById('depth_v').innerText = d.toFixed(1);
        const cfg = JSON.parse(localStorage.getItem('flood_cfg_intl') || '{"w":30,"a":60,"c":100}');
        const statusEl = document.getElementById('ai_t');
        let curSt = "", clr = 3066993, pri = "LOW", p_icon = "üü¢";

        // ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏±‡πà‡∏á Mute/Unmute ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß
        if(d >= (parseFloat(cfg.c) + 0.5)) { 
            curSt = dict[currentLang].danger_st; 
            statusEl.style.color = "var(--danger)"; clr = 15158332; pri = dict[currentLang].pri_high; p_icon = "üî¥";
        }
        else if(d >= (parseFloat(cfg.a) + 0.5)) { 
            curSt = dict[currentLang].alert_st; 
            statusEl.style.color = "var(--warn)"; clr = 15105570; pri = dict[currentLang].pri_med; p_icon = "üü†";
        }
        else if(d >= (parseFloat(cfg.w) + 0.5)) { 
            curSt = dict[currentLang].warn_st; 
            statusEl.style.color = "var(--accent)"; clr = 3447003; pri = dict[currentLang].pri_med; p_icon = "üü°";
        }
        else { 
            curSt = dict[currentLang].safe; 
            statusEl.style.color = "var(--safe)"; clr = 3066993; pri = dict[currentLang].pri_low; p_icon = "üü¢";
        }
        
        statusEl.innerText = curSt;

        if (curSt !== lastSentLevel && (Date.now() - lastNotifyTime > NOTIFY_COOLDOWN)) {
            sendDiscordPremium(curSt, d, clr, pri, p_icon);
            lastSentLevel = curSt; lastNotifyTime = Date.now();
        }
        if(floodChart) { floodChart.data.datasets[0].data.push(d); floodChart.data.datasets[0].data.shift(); floodChart.update('none'); }
    }

    async function sendDiscordPremium(st, dp, cl, pr, ic) {
        const url = document.getElementById('discord').value;
        if (!url || !url.startsWith('http')) return;
        const d = dict[currentLang];
        const body = {
            username: "HydroGuard Bot",
            avatar_url: "https://cdn-icons-png.flaticon.com/512/3105/3105807.png",
            embeds: [{
                title: d.dis_title,
                description: `‚ö†Ô∏è **${d.dis_sub}**\n[${d.dis_link}](https://google.com)`,
                color: cl,
                thumbnail: { url: "https://cdn-icons-png.flaticon.com/512/564/564619.png" },
                fields: [
                    { name: d.dis_status, value: `**${d.dis_lvl}:** ${ic} ${st}\n**${d.dis_pri}:** ${ic} ${pr}`, inline: false },
                    { name: d.dis_now, value: `\`\`\`ansi\n\u001b[1;34m ${dp.toFixed(2)} cm\n\`\`\``, inline: true },
                    { name: d.dis_inst, value: `\`\`\`ansi\n\u001b[1;30m ${installHeight.toFixed(2)} cm\n\`\`\``, inline: true },
                    { name: d.dis_anal, value: `| *${d.dis_footer}*`, inline: false }
                ],
                footer: { text: `NODE-ID: ESP32-PRO-V1 ‚Ä¢ ${new Date().toLocaleTimeString('th-TH')} ‚Ä¢ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡πÄ‡∏ß‡∏•‡∏≤ ${new Date().getHours()}:${new Date().getMinutes()}`, icon_url: "https://cdn-icons-png.flaticon.com/512/2995/2995657.png" }
            }]
        };
        fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
    }

    function toggleMute() {
        isMuted = !isMuted;
        const btn = document.getElementById('muteBtn');
        btn.innerText = isMuted ? dict[currentLang].audio_off : dict[currentLang].audio_on;
        btn.classList.toggle('muted', isMuted);
        if(client.connected) client.publish('flood/cmd/mute', isMuted ? '1' : '0');
    }

    function setLang(lang) {
        currentLang = lang; localStorage.setItem('pref_lang', lang);
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + lang).classList.add('active');
        const d = dict[lang];
        document.getElementById('main-title').innerText = d.title;
        document.getElementById('sub-title').innerText = d.subtitle;
        document.getElementById('lbl-settings').innerText = d.settings;
        document.getElementById('lbl-calib-title').innerText = d.calib_t;
        document.getElementById('btn-calib-txt').innerText = d.btn_calib;
        document.getElementById('lbl-thresholds').innerText = d.thresholds;
        document.getElementById('lbl-watch').innerText = d.watch;
        document.getElementById('lbl-alert').innerText = d.alert;
        document.getElementById('lbl-danger').innerText = d.danger;
        document.getElementById('lbl-notify').innerText = d.notify;
        document.getElementById('btn-save-txt').innerText = d.btn_save;
        document.getElementById('btn-reset-txt').innerText = d.btn_reset;
        document.getElementById('lbl-depth').innerText = d.depth;
        document.getElementById('lbl-unit-cm').innerText = d.unit_cm;
        document.getElementById('lbl-status').innerText = d.status;
        document.getElementById('lbl-raw').innerText = d.raw;
        document.getElementById('ai_wait').innerText = d.wait;
        document.getElementById('calib-msg').innerText = d.calib_msg;
        document.getElementById('muteBtn').innerText = isMuted ? d.audio_off : d.audio_on;
        document.getElementById('sync-base').innerText = installHeight > 0 ? d.sync_ok : d.sync_wait;
        updateStatusText();
    }

    function saveSettings() {
        const h = document.getElementById('base_h').value;
        const c = document.getElementById('th_c').value;
        const cfg = { h, w: document.getElementById('th_w').value, a: document.getElementById('th_a').value, c: c, u: document.getElementById('discord').value };
        localStorage.setItem('flood_cfg_intl', JSON.stringify(cfg));
        installHeight = parseFloat(h);
        if(client.connected) {
            client.publish('flood/cmd/set_base', h.toString());
            client.publish('flood/cmd/set_critical', c.toString()); // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ Critical ‡πÑ‡∏õ‡∏ö‡∏≠‡∏£‡πå‡∏î
        }
        Swal.fire({ icon: 'success', title: currentLang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : 'Saved & Synced!', background: '#161c2e', color: '#fff', timer: 1000, showConfirmButton: false });
    }

    function initChart() {
        const ctx = document.getElementById('floodChart').getContext('2d');
        floodChart = new Chart(ctx, {
            type: 'line',
            data: { labels: Array(30).fill(''), datasets: [{ label: 'Depth CM', data: Array(30).fill(0), borderColor: '#00d2ff', backgroundColor: 'rgba(0, 210, 255, 0.05)', fill: true, tension: 0.4 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true }, x: { display: false } }, plugins: { legend: { display: false } } }
        });
    }

    function updateStatusText() {
        const isOnline = (Date.now() - lastSeen < 8000);
        const txt = document.getElementById('st_text');
        const st = document.getElementById('st_tag');
        if(!txt) return;
        txt.innerText = isOnline ? dict[currentLang].live : dict[currentLang].offline;
        st.style.color = isOnline ? "var(--safe)" : "var(--danger)";
        st.style.background = isOnline ? "rgba(0,255,136,0.1)" : "rgba(255,0,85,0.1)";
    }

    function startCalib() { document.getElementById('calibOverlay').style.display = 'flex'; isCalib = true; samples = []; client.publish('flood/cmd/setup', '1'); }
    function finalizeCalib() { isCalib = false; document.getElementById('calibOverlay').style.display = 'none'; samples.sort((a,b) => a-b); const median = samples[Math.floor(samples.length/2)]; document.getElementById('base_h').value = median.toFixed(1); saveSettings(); }
    function factoryReset() { localStorage.clear(); location.reload(); }

    setInterval(updateStatusText, 4000);
    window.onload = () => { initChart(); setLang(localStorage.getItem('pref_lang') || 'th'); const saved = JSON.parse(localStorage.getItem('flood_cfg_intl') || '{}'); if(saved.h) { installHeight = parseFloat(saved.h); document.getElementById('base_h').value = saved.h; document.getElementById('th_w').value = saved.w; document.getElementById('th_a').value = saved.a; document.getElementById('th_c').value = saved.c; document.getElementById('discord').value = saved.u; } };
</script>
</body>
</html>
