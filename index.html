<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Flood Analysis Engine | Command Center</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b0f1a;
            --card-bg: rgba(23, 28, 41, 0.7);
            --accent: #00d2ff;
            --safe: #00ff88;
            --warn: #ffab00;
            --danger: #ff0055;
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        * { box-sizing: border-box; transition: all 0.3s ease; }
        body { 
            font-family: 'Prompt', sans-serif; 
            margin: 0; background: var(--bg); color: #fff; 
            display: flex; min-height: 100vh;
            background-image: radial-gradient(circle at 0% 0%, #16203a 0%, #0b0f1a 50%);
        }

        .sidebar { 
            width: 340px; background: rgba(10, 15, 28, 0.95); backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border); padding: 30px; display: flex; flex-direction: column; gap: 15px;
        }

        .lang-switch { display: flex; gap: 5px; margin-bottom: 10px; background: rgba(255,255,255,0.05); padding: 5px; border-radius: 12px; }
        .lang-btn { flex: 1; border: none; background: transparent; color: #6b7280; padding: 8px; cursor: pointer; border-radius: 8px; font-weight: 600; }
        .lang-btn.active { background: var(--accent); color: #000; }

        .config-card { background: var(--card-bg); border: 1px solid var(--glass-border); border-radius: 20px; padding: 20px; }
        .config-card label { font-size: 0.7rem; color: #6b7280; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 8px; }
        .config-card input { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #334155; background: #0f172a; color: var(--accent); font-weight: bold; margin-bottom: 8px; }

        .main { flex: 1; padding: 40px; overflow-y: auto; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card-bg); border: 1px solid var(--glass-border); border-radius: 28px; padding: 25px; text-align: center; }
        .stat-value { font-family: 'Orbitron', sans-serif; font-size: 3rem; font-weight: 700; margin: 10px 0; }

        .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-calib { background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%); color: #000; }
        .btn-reset { background: rgba(255,0,85,0.1); color: var(--danger); border: 1px solid var(--danger); }
        .btn-save { background: var(--safe); color: #000; margin-top: 10px; }
        .btn-mute { background: rgba(255,255,255,0.05); color: #fff; width: auto; padding: 10px 20px; border: 1px solid var(--glass-border); }

        .chart-section { background: var(--card-bg); border: 1px solid var(--glass-border); border-radius: 28px; padding: 25px; height: 400px; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; animation: pulse 2s infinite; }

        #calibOverlay { display:none; position:fixed; inset:0; background:rgba(11,15,26,0.98); z-index:9999; flex-direction:column; justify-content:center; align-items:center; }

        @media (max-width: 1100px) { body { flex-direction: column; } .sidebar { width: 100%; } .stats-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="lang-switch">
        <button class="lang-btn active" onclick="setLang('th')" id="btn-th">TH</button>
        <button class="lang-btn" onclick="setLang('en')" id="btn-en">EN</button>
    </div>

    <div style="font-family: 'Orbitron'; font-size: 1.2rem; color: var(--accent); font-weight: 700; text-align: center;">HYDRO GUARD PRO</div>
    
    <div class="config-card">
        <label id="lbl-calib-title">Calibration</label>
        <button class="btn btn-calib" onclick="startCalib()" id="btn-calib-txt">‚ö° AUTO CALIBRATE</button>
        <input type="number" id="base_h" placeholder="0.00 CM" style="margin-top: 10px;" readonly>
    </div>

    <div class="config-card">
        <label id="lbl-thresholds">Thresholds (CM)</label>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div><label id="lbl-watch">WATCH</label><input type="number" id="th_w" value="30"></div>
            <div><label id="lbl-alert">ALERT</label><input type="number" id="th_a" value="60"></div>
        </div>
        <label id="lbl-danger">DANGER</label>
        <input type="number" id="th_c" value="100">
    </div>

    <div class="config-card">
        <label id="lbl-notify">Cloud Notification</label>
        <input type="text" id="discord" placeholder="Discord Webhook URL">
        <button class="btn btn-save" onclick="saveSettings()" id="btn-save-txt">SAVE CONFIG</button>
    </div>

    <button class="btn btn-reset" onclick="factoryReset()" id="btn-reset-txt">RESET SYSTEM</button>
</div>

<div class="main">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px;">
        <div>
            <h1 style="margin: 0; font-size: 1.5rem;" id="main-title">Monitoring Dashboard</h1>
            <p style="color: #6b7280; margin: 5px 0 0 0;" id="sub-title">Real-time Flood Analysis Engine</p>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <button id="muteBtn" class="btn btn-mute" onclick="toggleMute()">üîä AUDIO ON</button>
            <div id="st_tag" style="padding: 8px 15px; border-radius: 30px; font-size: 0.75rem; display: flex; align-items: center; gap: 8px;">
                <div class="dot"></div> <span id="st_text">CONNECTING...</span>
            </div>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div style="font-size: 0.8rem; color: #6b7280;" id="lbl-depth">WATER DEPTH</div>
            <div class="stat-value" id="depth_v" style="color: var(--accent);">0.0</div>
            <div style="font-size: 0.7rem; letter-spacing: 2px;">CENTIMETERS</div>
        </div>
        <div class="stat-card" id="status_card">
            <div style="font-size: 0.8rem; color: #6b7280;" id="lbl-status">SAFETY STATUS</div>
            <div id="ai_t" style="font-size: 1.5rem; font-weight: 700; margin: 20px 0; color: var(--safe);">STANDBY</div>
            <div id="ai_eta" style="font-size: 0.7rem; color: var(--accent);" id="lbl-wait">WAITING FOR DATA...</div>
        </div>
        <div class="stat-card">
            <div style="font-size: 0.8rem; color: #6b7280;" id="lbl-raw">SENSOR RAW</div>
            <div class="stat-value" id="raw_v" style="color: #334155; font-size: 2.5rem;">0.0</div>
            <div id="h_text" style="font-size: 0.7rem;">CALIBRATED: -- CM</div>
        </div>
    </div>

    <div class="chart-section"><canvas id="floodChart"></canvas></div>
</div>

<div id="calibOverlay">
    <div style="font-family:'Orbitron'; font-size: 6rem; color: var(--accent);" id="countdown">30</div>
    <h2 id="calib-msg">SCANNING TERRAIN...</h2>
    <div style="width: 200px; height: 2px; background: #334155; margin-top: 20px;"><div id="p_bar" style="width: 0%; height: 100%; background: var(--accent);"></div></div>
</div>

<script>
    // --- [ 1. CONFIG & MQTT ] ---
    const mqtt_url = 'wss://e10d38d9fdee4dd7809fd84de819c22a.s1.eu.hivemq.cloud:8884/mqtt';
    const mqtt_options = {
        username: '(Zee071250)', 
        password: '071250Za', 
        clientId: 'Web_Dash_' + Math.random().toString(16).substr(2, 5)
    };

    let installHeight = 0, isCalib = false, samples = [], lastSeen = 0, isMuted = false, currentLang = 'th';
    let lastAlertLevel = 0; 
    let floodChart;

    const client = mqtt.connect(mqtt_url, mqtt_options);

    const dict = {
        th: {
            title: "‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ô‡πâ‡∏≥", subtitle: "‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå", calib_t: "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏î‡∏¥‡∏ô", 
            btn_calib: "‚ö° ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏î‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥", thresholds: "‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡∏ã‡∏°.)", watch: "‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á", alert: "‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏†‡∏±‡∏¢",
            danger: "‡∏ß‡∏¥‡∏Å‡∏§‡∏ï", notify: "‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå", btn_save: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤", btn_reset: "‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö",
            depth: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∂‡∏Å‡∏ô‡πâ‡∏≥", status: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢", raw: "‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ã‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏î‡∏¥‡∏ö", wait: "‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...",
            live: "‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà", offline: "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå", calib_msg: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà...", 
            safe: "‡∏õ‡∏Å‡∏ï‡∏¥", warn_st: "‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á", alert_st: "‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏†‡∏±‡∏¢", danger_st: "‡∏ß‡∏¥‡∏Å‡∏§‡∏ï", audio_on: "üîä ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á", audio_off: "üîá ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á"
        },
        en: {
            title: "Monitoring Dashboard", subtitle: "Real-time Flood Analysis Engine", calib_t: "System Calibration", 
            btn_calib: "‚ö° AUTO CALIBRATE", thresholds: "Alert Thresholds (CM)", watch: "WATCH", alert: "ALERT",
            danger: "DANGER", notify: "Cloud Notification", btn_save: "SAVE CONFIG", btn_reset: "RESET SYSTEM",
            depth: "WATER DEPTH", status: "SAFETY STATUS", raw: "SENSOR RAW", wait: "WAITING FOR DATA...",
            live: "SYSTEM LIVE", offline: "DEVICE OFFLINE", calib_msg: "SCANNING TERRAIN...",
            safe: "SAFE", warn_st: "WATCH", alert_st: "ALERT", danger_st: "CRITICAL", audio_on: "üîä AUDIO ON", audio_off: "üîá AUDIO OFF"
        }
    };

    // --- [ 2. CORE LOGIC ] ---
    client.on('connect', () => {
        client.subscribe('flood/sensor/level');
        client.subscribe('flood/sensor/base_confirm');
        updateStatusText();
    });

    client.on('message', (t, m) => {
        const val = parseFloat(m.toString());
        lastSeen = Date.now();
        document.getElementById('raw_v').innerText = val.toFixed(1);

        if (isCalib) {
            samples.push(val);
            document.getElementById('p_bar').style.width = (samples.length/30)*100 + '%';
            document.getElementById('countdown').innerText = 30 - samples.length;
            if (samples.length >= 30) finalizeCalib();
        } else if (installHeight > 0) {
            const depth = Math.max(0, installHeight - val);
            updateDashboard(depth);
        }
    });

    function updateDashboard(d) {
        document.getElementById('depth_v').innerText = d.toFixed(1);
        const c = JSON.parse(localStorage.getItem('flood_cfg_intl') || '{"w":30,"a":60,"c":100}');
        const trend = document.getElementById('ai_t');
        let currentLv = 0;

        if(d >= c.c) { 
            currentLv = 3; trend.innerText = dict[currentLang].danger_st; trend.style.color = "var(--danger)"; 
            client.publish('flood/cmd/alarm', '1');
        } else if(d >= c.a) { 
            currentLv = 2; trend.innerText = dict[currentLang].alert_st; trend.style.color = "var(--warn)"; 
            client.publish('flood/cmd/alarm', '0');
        } else if(d >= c.w) { 
            currentLv = 1; trend.innerText = dict[currentLang].warn_st; trend.style.color = "var(--accent)";
            client.publish('flood/cmd/alarm', '0');
        } else { 
            currentLv = 0; trend.innerText = dict[currentLang].safe; trend.style.color = "var(--safe)"; 
            client.publish('flood/cmd/alarm', '0');
        }

        if (currentLv > lastAlertLevel) {
            sendDiscord(`üö® ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ${trend.innerText}\n‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥: ${d.toFixed(1)} cm`);
        }
        lastAlertLevel = currentLv;

        if(floodChart) {
            floodChart.data.datasets[0].data.push(d);
            floodChart.data.datasets[0].data.shift();
            floodChart.update('none');
        }
    }

    async function sendDiscord(msg) {
        const url = document.getElementById('discord').value;
        if (!url || !url.startsWith('http')) return;
        try {
            await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({content: msg}) });
        } catch (e) { console.error("Discord Error", e); }
    }

    function initChart() {
        const ctx = document.getElementById('floodChart').getContext('2d');
        floodChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array(20).fill(''),
                datasets: [{
                    label: 'Water Depth',
                    data: Array(20).fill(0),
                    borderColor: '#00d2ff',
                    backgroundColor: 'rgba(0, 210, 255, 0.1)',
                    fill: true, tension: 0.4
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { display: false } },
                plugins: { legend: { display: false } }
            }
        });
    }

    // --- [ 3. UI FUNCTIONS ] ---
    function setLang(lang) {
        currentLang = lang;
        localStorage.setItem('pref_lang', lang);
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + lang).classList.add('active');
        
        const d = dict[lang];
        document.getElementById('main-title').innerText = d.title;
        document.getElementById('sub-title').innerText = d.subtitle;
        document.getElementById('lbl-calib-title').innerText = d.calib_t;
        document.getElementById('btn-calib-txt').innerText = d.btn_calib;
        document.getElementById('lbl-thresholds').innerText = d.thresholds;
        document.getElementById('lbl-watch').innerText = d.watch;
        document.getElementById('lbl-alert').innerText = d.alert;
        document.getElementById('lbl-danger').innerText = d.danger;
        document.getElementById('lbl-notify').innerText = d.notify;
        document.getElementById('btn-save-txt').innerText = d.btn_save;
        document.getElementById('btn-reset-txt').innerText = d.btn_reset;
        document.getElementById('lbl-depth').innerText = d.depth;
        document.getElementById('lbl-status').innerText = d.status;
        document.getElementById('lbl-raw').innerText = d.raw;
        document.getElementById('calib-msg').innerText = d.calib_msg;
        document.getElementById('muteBtn').innerText = isMuted ? d.audio_off : d.audio_on;
        updateStatusText();
    }

    function startCalib() { 
        document.getElementById('calibOverlay').style.display = 'flex'; 
        isCalib = true; samples = []; 
        client.publish('flood/cmd/setup', '1');
    }

    function finalizeCalib() {
        isCalib = false; document.getElementById('calibOverlay').style.display = 'none';
        samples.sort((a,b) => a-b);
        const median = samples[Math.floor(samples.length/2)];
        document.getElementById('base_h').value = median.toFixed(1);
        installHeight = median;
        saveSettings();
    }

    function saveSettings() {
        const cfg = { h: document.getElementById('base_h').value, w: document.getElementById('th_w').value, a: document.getElementById('th_a').value, c: document.getElementById('th_c').value, u: document.getElementById('discord').value };
        localStorage.setItem('flood_cfg_intl', JSON.stringify(cfg));
        installHeight = parseFloat(cfg.h);
        document.getElementById('h_text').innerText = `CALIBRATED: ${installHeight} CM`;
        Swal.fire({ icon: 'success', title: currentLang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : 'SAVED', background: '#161c2e', color: '#fff', timer: 1000, showConfirmButton: false });
    }

    function toggleMute() {
        isMuted = !isMuted;
        document.getElementById('muteBtn').innerText = isMuted ? dict[currentLang].audio_off : dict[currentLang].audio_on;
        client.publish('flood/cmd/mute', isMuted ? '1' : '0');
    }

    function updateStatusText() {
        const isOnline = Date.now() - lastSeen < 8000;
        const txt = document.getElementById('st_text');
        const st = document.getElementById('st_tag');
        if(!txt) return;
        txt.innerText = isOnline ? dict[currentLang].live : dict[currentLang].offline;
        st.style.color = isOnline ? "var(--safe)" : "var(--danger)";
        st.style.background = isOnline ? "rgba(0,255,136,0.1)" : "rgba(255,0,85,0.1)";
    }

    function factoryReset() {
        Swal.fire({ title: currentLang === 'th' ? '‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?' : 'ERASE?', icon: 'warning', showCancelButton: true, background: '#161c2e', color: '#fff' }).then(r => { if(r.isConfirmed) { localStorage.clear(); location.reload(); }});
    }

    setInterval(updateStatusText, 4000);

    window.onload = () => {
        initChart();
        const savedLang = localStorage.getItem('pref_lang') || 'th';
        setLang(savedLang);
        const savedCfg = localStorage.getItem('flood_cfg_intl');
        if(savedCfg) {
            const c = JSON.parse(savedCfg);
            document.getElementById('base_h').value = c.h; 
            document.getElementById('th_w').value = c.w;
            document.getElementById('th_a').value = c.a; 
            document.getElementById('th_c').value = c.c;
            document.getElementById('discord').value = c.u;
            installHeight = parseFloat(c.h);
            document.getElementById('h_text').innerText = `CALIBRATED: ${installHeight} CM`;
        }
    };
</script>
</body>
</html>
